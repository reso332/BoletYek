<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discond</title>
<style>
  :root {
    --primary: #6d8ed1;
    --primary-light: #8fa8e0;
    --secondary: #e8f0fe;
    --text: #333;
    --text-light: #666;
    --white: #fff;
    --border: #ddd;
    --success: #4CAF50;
    --error: #ff4757;
    --warning: #ffa502;
    --google-blue: #4285F4;
    --google-green: #34A853;
    --google-yellow: #FBBC05;
    --google-red: #EA4335;
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #e8f0fe 100%);
    min-height: 100vh;
    color: var(--text);
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
  .login-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  
  .login-box {
    background: var(--white);
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
  
  .login-box h2 {
    color: var(--primary);
    margin-bottom: 30px;
    font-weight: 500;
  }
  
  .login-input {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
  }
  
  .login-input:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  .login-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 14px 30px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    transition: background 0.3s;
  }
  
  .login-btn:hover {
    background: var(--primary-light);
  }
  
  /* Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„ */
  .google-btn {
    background: var(--white);
    color: #757575;
    border: 2px solid #ddd;
    padding: 12px 30px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
    transition: all 0.3s;
  }
  
  .google-btn:hover {
    background: #f9f9f9;
    border-color: #ccc;
  }
  
  .google-icon {
    width: 24px;
    height: 24px;
  }
  
  .logout-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 15px;
    transition: background 0.3s;
  }
  
  .logout-btn:hover {
    background: #ff6b81;
  }
  
  /* Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
  .chat-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 20px;
    height: calc(100vh - 40px);
  }
  
  /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
  .sidebar {
    background: var(--white);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    overflow-y: auto;
  }
  
  .user-profile {
    text-align: center;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
  }
  
  .user-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 15px;
    border: 3px solid var(--secondary);
  }
  
  .user-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 10px;
  }
  
  .admin-badge {
    background: #ff4757;
    color: white;
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 12px;
    display: inline-block;
    margin-right: 10px;
  }
  
  /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù† */
  .admin-tools {
    background: #fff5f5;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid #ffcccc;
    display: none;
  }
  
  .admin-tools h3 {
    color: #ff4757;
    margin-bottom: 15px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .admin-tools h3:before {
    content: "ğŸ›¡ï¸";
  }
  
  .admin-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 10px;
  }
  
  .admin-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
  }
  
  .admin-btn:hover {
    background: #ff6b81;
  }
  
  .admin-btn.secondary {
    background: var(--primary);
  }
  
  .admin-btn.secondary:hover {
    background: var(--primary-light);
  }
  
  .admin-btn.danger {
    background: #ff4757;
  }
  
  .admin-btn.success {
    background: #4CAF50;
  }
  
  .admin-btn.warning {
    background: #ffa502;
  }
  
  /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± */
  .command-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  
  .command-modal-content {
    background: var(--white);
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .command-modal h3 {
    color: var(--primary);
    margin-bottom: 15px;
    text-align: center;
  }
  
  .command-users-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .command-user-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .command-user-item:hover {
    background: #e8f0fe;
  }
  
  .command-user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .command-user-info {
    flex: 1;
    min-width: 0;
  }
  
  .command-user-name {
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .command-user-id {
    font-size: 12px;
    color: var(--text-light);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .command-modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  
  .command-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .command-cancel {
    background: var(--border);
    color: var(--text);
  }
  
  /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª */
  .chat-area {
    display: flex;
    flex-direction: column;
    background: var(--white);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }
  
  .messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #fafafa;
  }
  
  .chat-locked {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
  }
  
  .chat-locked h3 {
    color: #ff4757;
    margin-bottom: 10px;
  }
  
  .message {
    display: flex;
    margin-bottom: 20px;
    max-width: 80%;
  }
  
  .message.other {
    align-self: flex-start;
  }
  
  .message.self {
    align-self: flex-end;
    flex-direction: row-reverse;
  }
  
  .message.admin {
    border-right: 3px solid #ff4757;
  }
  
  .message.system {
    border-right: 3px solid #4CAF50;
    max-width: 100%;
    justify-content: center;
  }
  
  .message.system .message-content {
    background: #e8f5e9;
    color: #2e7d32;
  }
  
  .message.muted {
    opacity: 0.5;
  }
  
  .message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 10px;
    flex-shrink: 0;
  }
  
  .message-content {
    background: var(--secondary);
    padding: 12px 16px;
    border-radius: 12px;
    max-width: calc(100% - 60px);
    position: relative;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
  }
  
  .message.self .message-content {
    background: var(--primary-light);
    color: white;
  }
  
  .message.admin .message-content {
    background: #fff5f5;
    border: 1px solid #ffcccc;
  }
  
  .message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
    gap: 10px;
  }
  
  .message-name {
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  .message.admin .message-name {
    color: #ff4757;
  }
  
  .message-time {
    font-size: 12px;
    color: var(--text-light);
    flex-shrink: 0;
  }
  
  .message.self .message-time {
    color: rgba(255, 255, 255, 0.8);
  }
  
  .message-text {
    line-height: 1.5;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
  }
  
  .delete-btn {
    position: absolute;
    left: -25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ff4757;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 12px;
    display: none;
  }
  
  .message:hover .delete-btn {
    display: block;
  }
  
  /* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
  .input-area {
    padding: 20px;
    border-top: 1px solid var(--border);
    background: var(--white);
    position: relative;
  }
  
  .chat-locked .input-area {
    filter: blur(2px);
    pointer-events: none;
  }
  
  .message-input-row {
    display: flex;
    gap: 10px;
  }
  
  #message-input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
    resize: none;
    height: 60px;
    font-family: inherit;
  }
  
  #message-input:disabled {
    background: #f5f5f5;
    cursor: not-allowed;
  }
  
  #message-input:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  #send-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0 25px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
    flex-shrink: 0;
  }
  
  #send-btn:disabled {
    background: #cccccc;
    cursor: not-allowed;
  }
  
  #send-btn:hover:not(:disabled) {
    background: var(--primary-light);
  }
  
  .status {
    text-align: center;
    padding: 10px;
    font-size: 14px;
    color: var(--text-light);
    background: var(--secondary);
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .chat-status {
    background: #fff5f5;
    color: #ff4757;
    padding: 10px;
    text-align: center;
    font-weight: bold;
  }
  
  /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 3000;
    animation: slideIn 0.3s ease;
    border-right: 4px solid var(--primary);
    max-width: 300px;
  }
  
  .notification.error {
    border-right-color: #ff4757;
  }
  
  .notification.success {
    border-right-color: #4CAF50;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„ */
  .message-reactions {
    display: flex;
    gap: 5px;
    margin-top: 8px;
    flex-wrap: wrap;
  }
  
  .reaction-btn {
    background: #f0f0f0;
    border: none;
    border-radius: 12px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 3px;
    transition: background 0.2s;
  }
  
  .reaction-btn:hover {
    background: #e0e0e0;
  }
  
  .reaction-count {
    font-size: 11px;
    color: #666;
  }
  
  /* Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© */
  .typing-indicator {
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 14px;
    display: none;
    z-index: 100;
  }
  
  /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± */
  .command-palette {
    position: fixed;
    top: 20%;
    right: 50%;
    transform: translateX(50%);
    background: var(--white);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    padding: 15px;
    z-index: 2000;
    min-width: 300px;
    display: none;
  }
  
  .command-item {
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .command-item:hover {
    background: #f5f5f5;
  }
  
  .command-shortcut {
    color: var(--text-light);
    font-size: 12px;
    margin-right: auto;
  }
  
  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
  @media (max-width: 768px) {
    .chat-layout {
      grid-template-columns: 1fr;
    }
    
    .sidebar {
      display: none;
    }
    
    .message {
      max-width: 90%;
    }
    
    .command-palette {
      width: 90%;
      right: 5%;
      transform: none;
    }
  }
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Discond</h2>
    <p style="color: var(--text-light); margin-bottom: 20px;">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</p>
    
    <!-- Ø®ÙŠØ§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„ -->
    <button id="googleLoginBtn" class="google-btn">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon" alt="Google">
      ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„
    </button>
    
    <div style="margin: 20px 0; position: relative;">
      <div style="height: 1px; background: var(--border);"></div>
      <div style="position: absolute; top: -10px; right: calc(50% - 20px); background: white; padding: 0 10px; color: var(--text-light);">Ø£Ùˆ</div>
    </div>
    
    <!-- Ø®ÙŠØ§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ -->
    <input type="text" id="userName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" maxlength="20">
    <input type="text" id="userAvatar" class="login-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ùƒ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙØ§Ø±ØºØ§Ù‹</p>
    
    <button id="loginBtn" class="login-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± -->
<div id="commandModal" class="command-modal" style="display: none;">
  <div class="command-modal-content">
    <h3 id="commandModalTitle">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
    <div class="command-users-list" id="commandUsersList">
      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
    </div>
    <div class="command-modal-buttons">
      <button id="commandCancelBtn" class="command-btn command-cancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± -->
<div id="commandPalette" class="command-palette">
  <h4 style="margin-bottom: 15px; color: var(--primary);">Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h4>
  <div id="commandList">
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
  </div>
</div>

<!-- Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© -->
<div id="typingIndicator" class="typing-indicator">
  <span id="typingText">Ø´Ø®Øµ Ù…Ø§ ÙŠÙƒØªØ¨...</span>
</div>

<!-- Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="container" style="display: none;" id="mainApp">
  <div class="chat-layout">
    
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
    <div class="chat-area">
      <!-- Ø­Ø§Ù„Ø© Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
      <div id="chatLocked" class="chat-locked" style="display: none;">
        <h3>ğŸ”’ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹</h3>
        <p id="lockReason">Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹...</p>
        <p id="lockTime" style="font-size: 12px; color: #666;"></p>
      </div>
      
      <div id="messagesContainer" class="messages-container">
        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
      </div>
      
      <div class="input-area">
        <div class="message-input-row">
          <textarea id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§... (Ù„Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø§Ø¶ØºØ· /)"></textarea>
          <button id="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
      </div>
      
      <div class="status">
        <span id="onlineStatus">âœ“ Ù…ØªØµÙ„</span>
        â€¢ <span id="messageCount">0 Ø±Ø³Ø§Ù„Ø©</span>
        â€¢ <span id="userCount">0 Ù…Ø³ØªØ®Ø¯Ù…</span>
      </div>
    </div>
    
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
    <div class="sidebar">
      <div class="user-profile">
        <img id="profileAvatar" class="user-avatar" src="https://ui-avatars.com/api/?name=Ù…Ø³ØªØ®Ø¯Ù…&background=6d8ed1&color=fff" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù">
        <div class="user-name" id="profileName">
          <span id="adminBadge" class="admin-badge" style="display: none;">Ø¥Ø¯Ù…Ù†</span>
          Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        </div>
        <div style="color: var(--text-light); font-size: 14px; margin-bottom: 10px;">Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø·</div>
        <div style="color: var(--primary); font-size: 12px; background: #e8f0fe; padding: 5px 10px; border-radius: 15px;">
          ID: <span id="userIdText">---</span>
        </div>
        
        <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
        <button id="logoutBtn" class="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
      
      <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù† -->
      <div id="adminTools" class="admin-tools">
        <h3>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù†</h3>
        
        <div class="admin-buttons">
          <button id="lockBtn" class="admin-btn danger">
            <span>ğŸ”’</span> Ù‚ÙÙ„
          </button>
          <button id="unlockBtn" class="admin-btn success">
            <span>ğŸ”“</span> ÙØªØ­
          </button>
        </div>
        
        <div class="admin-buttons">
          <button id="muteBtn" class="admin-btn warning">
            <span>ğŸ¤«</span> ÙƒØªÙ…
          </button>
          <button id="unmuteBtn" class="admin-btn warning">
            <span>ğŸ¤</span> Ø¥Ø²Ø§Ù„Ø© ÙƒØªÙ…
          </button>
        </div>
        
        <div class="admin-buttons">
          <button id="roleBtn" class="admin-btn secondary">
            <span>ğŸ‘‘</span> ØªØ±Ù‚ÙŠØ©
          </button>
          <button id="unroleBtn" class="admin-btn secondary">
            <span>ğŸ‘¤</span> Ø¥Ø²Ø§Ù„Ø© ØªØ±Ù‚ÙŠØ©
          </button>
        </div>
        
        <div style="margin-top: 15px;">
          <button id="clearChatBtn" class="admin-btn danger" style="width: 100%;">
            <span>ğŸ—‘ï¸</span> Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
          </button>
        </div>
        
        <div style="margin-top: 15px;">
          <button id="statsBtn" class="admin-btn secondary" style="width: 100%;">
            <span>ğŸ“Š</span> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          </button>
        </div>
        
        <div style="font-size: 11px; color: #666; margin-top: 10px; text-align: center;">
          Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onValue, set, remove, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC8jmHxQ5tIwuh9J_Y9TpovequFVigiXYw",
    authDomain: "disconde-17f43.firebaseapp.com",
    databaseURL: "https://disconde-17f43-default-rtdb.firebaseio.com",
    projectId: "disconde-17f43",
    storageBucket: "disconde-17f43.firebasestorage.app",
    messagingSenderId: "1009347423340",
    appId: "1:1009347423340:web:a86dee5c542544ab223c49",
    measurementId: "G-8Q05LMTRDX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const googleProvider = new GoogleAuthProvider();

  // Ù…Ø±Ø§Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const messagesRef = ref(db, 'messages');
  const usersRef = ref(db, 'users');
  const chatSettingsRef = ref(db, 'settings/chat');
  const mutedUsersRef = ref(db, 'mutedUsers');
  const typingRef = ref(db, 'typing');
  const reactionsRef = ref(db, 'reactions');

  // Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
  const loginScreen = document.getElementById('loginScreen');
  const mainApp = document.getElementById('mainApp');
  const googleLoginBtn = document.getElementById('googleLoginBtn');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userNameInput = document.getElementById('userName');
  const userAvatarInput = document.getElementById('userAvatar');
  const profileName = document.getElementById('profileName');
  const profileAvatar = document.getElementById('profileAvatar');
  const adminBadge = document.getElementById('adminBadge');
  const userIdText = document.getElementById('userIdText');
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const messageCount = document.getElementById('messageCount');
  const userCount = document.getElementById('userCount');
  const onlineStatus = document.getElementById('onlineStatus');
  const chatLocked = document.getElementById('chatLocked');
  const lockReason = document.getElementById('lockReason');
  const lockTime = document.getElementById('lockTime');
  const typingIndicator = document.getElementById('typingIndicator');
  const typingText = document.getElementById('typingText');
  const commandPalette = document.getElementById('commandPalette');
  const commandList = document.getElementById('commandList');
  
  // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù†
  const adminTools = document.getElementById('adminTools');
  const lockBtn = document.getElementById('lockBtn');
  const unlockBtn = document.getElementById('unlockBtn');
  const muteBtn = document.getElementById('muteBtn');
  const unmuteBtn = document.getElementById('unmuteBtn');
  const roleBtn = document.getElementById('roleBtn');
  const unroleBtn = document.getElementById('unroleBtn');
  const clearChatBtn = document.getElementById('clearChatBtn');
  const statsBtn = document.getElementById('statsBtn');
  
  // Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
  const commandModal = document.getElementById('commandModal');
  const commandModalTitle = document.getElementById('commandModalTitle');
  const commandUsersList = document.getElementById('commandUsersList');
  const commandCancelBtn = document.getElementById('commandCancelBtn');

  // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ID Ù‚ØµÙŠØ±
  function generateShortId() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // Ø¯Ø§Ù„Ø© Ù„ØªØ¹Ù‚ÙŠÙ… Ø§Ù„Ù†Øµ
  function sanitizeText(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  let currentUser = {
    uid: '',
    name: '',
    email: '',
    avatar: '',
    shortId: '',
    isAdmin: false,
    isGoogleUser: false
  };

  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…
  let chatLockedUntil = null;
  let mutedUsers = {};
  let messageCountValue = 0;
  let userCountValue = 0;
  let currentCommand = '';
  let typingTimeout = null;

  // Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©
  const availableReactions = ['ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ”¥', 'ğŸ‰'];

  // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      await handleLoggedInUser(user);
    } else {
      // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      loginScreen.style.display = 'flex';
      mainApp.style.display = 'none';
    }
  });

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
  async function handleLoggedInUser(firebaseUser) {
    try {
      currentUser.uid = firebaseUser.uid;
      currentUser.name = firebaseUser.displayName || firebaseUser.email.split('@')[0];
      currentUser.email = firebaseUser.email;
      currentUser.avatar = firebaseUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=6d8ed1&color=fff`;
      currentUser.shortId = generateShortId();
      currentUser.isGoogleUser = !!firebaseUser.providerData[0]?.providerId.includes('google');
      
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      await set(ref(db, `users/${currentUser.uid}`), {
        name: currentUser.name,
        shortId: currentUser.shortId,
        avatar: currentUser.avatar,
        email: currentUser.email,
        isAdmin: false,
        isGoogleUser: currentUser.isGoogleUser,
        lastSeen: serverTimestamp(),
        joinedAt: serverTimestamp()
      });
      
      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      profileName.textContent = currentUser.name;
      profileAvatar.src = currentUser.avatar;
      userIdText.textContent = currentUser.shortId;
      
      // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Øª
      loginScreen.style.display = 'none';
      mainApp.style.display = 'block';
      
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      messageInput.focus();
      
      // Ù…Ø±Ø§Ù‚Ø¨Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø¯Ù…Ù†
      monitorAdminStatus();
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
      monitorChatSettings();
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØªÙˆÙ…ÙŠÙ†
      monitorMutedUsers();
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
      monitorTyping();
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      monitorUserCount();
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„
  googleLoginBtn.addEventListener('click', async () => {
    try {
      const result = await signInWithPopup(auth, googleProvider);
      // Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ onAuthStateChanged
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„', 'error');
    }
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
  loginBtn.addEventListener('click', async () => {
    const name = userNameInput.value.trim();
    const avatar = userAvatarInput.value.trim();
    
    if (!name) {
      showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
      return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ‡Ù…ÙŠ (ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Authentication)
    const mockUser = {
      uid: 'user_' + Date.now(),
      displayName: name,
      email: name.toLowerCase().replace(/\s+/g, '') + '@example.com',
      photoURL: avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=6d8ed1&color=fff`
    };
    
    await handleLoggedInUser(mockUser);
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  logoutBtn.addEventListener('click', async () => {
    try {
      if (currentUser.isGoogleUser) {
        await signOut(auth);
      } else {
        // Ø¥Ø²Ø§Ù„Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase Realtime Database
        await remove(ref(db, `users/${currentUser.uid}`));
        await remove(ref(db, `typing/${currentUser.uid}`));
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      currentUser = {
        uid: '',
        name: '',
        email: '',
        avatar: '',
        shortId: '',
        isAdmin: false,
        isGoogleUser: false
      };
      
      showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
      loginScreen.style.display = 'flex';
      mainApp.style.display = 'none';
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
      await push(messagesRef, {
        userId: 'system',
        userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
        userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
        text: `ğŸ‘‹ Ø®Ø±Ø¬ ${currentUser.name} Ù…Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.`,
        timestamp: serverTimestamp(),
        isSystem: true
      });
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'error');
    }
  });

  // Ù…Ø±Ø§Ù‚Ø¨Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø¯Ù…Ù†
  function monitorAdminStatus() {
    const userRef = ref(db, `users/${currentUser.uid}/isAdmin`);
    
    onValue(userRef, (snapshot) => {
      if (snapshot.exists()) {
        const isAdmin = snapshot.val();
        currentUser.isAdmin = isAdmin;
        
        if (isAdmin) {
          adminBadge.style.display = 'inline-block';
          adminTools.style.display = 'block';
          profileName.style.color = '#ff4757';
        } else {
          adminBadge.style.display = 'none';
          adminTools.style.display = 'none';
          profileName.style.color = '';
        }
      }
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  function monitorChatSettings() {
    onValue(chatSettingsRef, (snapshot) => {
      if (snapshot.exists()) {
        const settings = snapshot.val();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„
        if (settings.isLocked) {
          chatLocked.style.display = 'flex';
          messageInput.disabled = true;
          sendBtn.disabled = true;
          
          lockReason.textContent = settings.lockReason || 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù†';
          
          if (settings.lockedUntil) {
            const lockDate = new Date(settings.lockedUntil);
            const now = new Date();
            const diff = lockDate - now;
            
            if (diff > 0) {
              const minutes = Math.ceil(diff / (1000 * 60));
              lockTime.textContent = `Ø³ØªÙØªØ­ Ø¨Ø¹Ø¯ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
              chatLockedUntil = settings.lockedUntil;
            } else {
              // Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ù‚ÙÙ„
              set(chatSettingsRef, {
                isLocked: false,
                lockedBy: null,
                lockReason: null,
                lockedUntil: null,
                lockedAt: null
              });
            }
          }
        } else {
          chatLocked.style.display = 'none';
          messageInput.disabled = false;
          sendBtn.disabled = false;
          chatLockedUntil = null;
        }
      } else {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        set(chatSettingsRef, {
          isLocked: false,
          lockedBy: null,
          lockReason: null,
          lockedUntil: null,
          lockedAt: null
        });
      }
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØªÙˆÙ…ÙŠÙ†
  function monitorMutedUsers() {
    onValue(mutedUsersRef, (snapshot) => {
      if (snapshot.exists()) {
        mutedUsers = snapshot.val();
      } else {
        mutedUsers = {};
      }
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
  function monitorTyping() {
    onValue(typingRef, (snapshot) => {
      if (snapshot.exists()) {
        const typingUsers = snapshot.val();
        const typingUserIds = Object.keys(typingUsers);
        
        // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        const otherTypingUsers = typingUserIds.filter(id => id !== currentUser.uid);
        
        if (otherTypingUsers.length > 0) {
          // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠÙƒØªØ¨ÙˆÙ†
          const userPromises = otherTypingUsers.map(userId => 
            get(ref(db, `users/${userId}/name`)).then(snap => snap.val())
          );
          
          Promise.all(userPromises).then(names => {
            if (names.length === 1) {
              typingText.textContent = `${names[0]} ÙŠÙƒØªØ¨...`;
            } else if (names.length === 2) {
              typingText.textContent = `${names[0]} Ùˆ ${names[1]} ÙŠÙƒØªØ¨Ø§Ù†...`;
            } else {
              typingText.textContent = `${names.length} Ø£Ø´Ø®Ø§Øµ ÙŠÙƒØªØ¨ÙˆÙ†...`;
            }
            typingIndicator.style.display = 'block';
          });
        } else {
          typingIndicator.style.display = 'none';
        }
      } else {
        typingIndicator.style.display = 'none';
      }
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  function monitorUserCount() {
    onValue(usersRef, (snapshot) => {
      if (snapshot.exists()) {
        const users = snapshot.val();
        userCountValue = Object.keys(users).length;
        userCount.textContent = `${userCountValue} Ù…Ø³ØªØ®Ø¯Ù…`;
      } else {
        userCountValue = 0;
        userCount.textContent = '0 Ù…Ø³ØªØ®Ø¯Ù…';
      }
    });
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
  async function showCommandModal(command, title) {
    currentCommand = command;
    commandModalTitle.textContent = title;
    commandUsersList.innerHTML = '';
    
    try {
      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const usersSnapshot = await new Promise((resolve) => {
        onValue(usersRef, (snapshot) => {
          resolve(snapshot);
        }, { onlyOnce: true });
      });
      
      if (usersSnapshot.exists()) {
        const users = usersSnapshot.val();
        const userArray = [];
        
        for (const userId in users) {
          const user = users[userId];
          
          // ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
          if (userId === currentUser.uid) continue;
          
          userArray.push({
            id: userId,
            shortId: user.shortId || 'N/A',
            name: user.name,
            avatar: user.avatar,
            isAdmin: user.isAdmin || false
          });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        userArray.forEach(user => {
          const userItem = document.createElement('div');
          userItem.className = 'command-user-item';
          userItem.dataset.userId = user.id;
          
          userItem.innerHTML = `
            <img src="${user.avatar}" class="command-user-avatar" alt="${user.name}"
                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=6d8ed1&color=fff'">
            <div class="command-user-info">
              <div class="command-user-name">${user.name} (${user.shortId})</div>
              <div class="command-user-id">ID: ${user.id}</div>
            </div>
          `;
          
          userItem.addEventListener('click', () => {
            executeCommand(command, user.id, user.name, user.shortId);
            hideCommandModal();
          });
          
          commandUsersList.appendChild(userItem);
        });
        
        if (userArray.length === 0) {
          commandUsersList.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ†</p>';
        }
      } else {
        commandUsersList.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</p>';
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
      commandUsersList.innerHTML = '<p style="text-align: center; color: #ff4757;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>';
    }
    
    commandModal.style.display = 'flex';
  }

  // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
  function hideCommandModal() {
    commandModal.style.display = 'none';
    currentCommand = '';
  }

  // Ø²Ø± Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  lockBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    executeCommand('lock', null, null, null);
  });

  // Ø²Ø± ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  unlockBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    executeCommand('unlock', null, null, null);
  });

  // Ø²Ø± ÙƒØªÙ… Ù…Ø³ØªØ®Ø¯Ù…
  muteBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    showCommandModal('mute', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙƒØªÙ…');
  });

  // Ø²Ø± Ø¥Ø²Ø§Ù„Ø© ÙƒØªÙ…
  unmuteBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    showCommandModal('unmute', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ…');
  });

  // Ø²Ø± ØªØ±Ù‚ÙŠØ© Ù„Ø¥Ø¯Ù…Ù†
  roleBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    showCommandModal('role', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ±Ù‚ÙŠØªÙ‡ Ø¥Ù„Ù‰ Ø¥Ø¯Ù…Ù†');
  });

  // Ø²Ø± Ø¥Ø²Ø§Ù„Ø© ØªØ±Ù‚ÙŠØ© Ø¥Ø¯Ù…Ù†
  unroleBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    showCommandModal('unrole', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù†');
  });

  // Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
  clearChatBtn.addEventListener('click', async () => {
    if (!currentUser.isAdmin) return;
    
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
      try {
        await remove(messagesRef);
        showNotification('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…
        await push(messagesRef, {
          userId: 'system',
          userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
          userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
          text: `ğŸ—‘ï¸ Ù‚Ø§Ù… ${currentUser.name} (${currentUser.shortId}) Ø¨Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.`,
          timestamp: serverTimestamp(),
          isSystem: true
        });
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'error');
      }
    }
  });

  // Ø²Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  statsBtn.addEventListener('click', async () => {
    if (!currentUser.isAdmin) return;
    
    try {
      const usersSnapshot = await get(usersRef);
      const messagesSnapshot = await get(messagesRef);
      
      const totalUsers = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
      const totalMessages = messagesSnapshot.exists() ? Object.keys(messagesSnapshot.val()).length : 0;
      const adminCount = usersSnapshot.exists() ? 
        Object.values(usersSnapshot.val()).filter(u => u.isAdmin).length : 0;
      
      alert(`
ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${totalUsers}
ğŸ’¬ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${totalMessages}
ğŸ‘‘ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¯Ù…Ù†: ${adminCount}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      `);
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
    }
  });

  // Ø¥Ù„ØºØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
  commandCancelBtn.addEventListener('click', hideCommandModal);

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø£ÙˆØ§Ù…Ø±
  async function executeCommand(command, targetUserId, targetUserName, targetShortId) {
    try {
      switch(command) {
        case 'lock':
          // Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¥Ù„Ø§ Ø§Ù„Ø¥Ø¯Ù…Ù†
          await set(chatSettingsRef, {
            isLocked: true,
            lockedBy: currentUser.shortId,
            lockReason: 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ù‚ÙÙˆÙ„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù†',
            lockedUntil: null,
            lockedAt: serverTimestamp()
          });
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `ğŸ”’ Ù‚Ø§Ù… ${currentUser.name} (${currentUser.shortId}) Ø¨Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©. ÙÙ‚Ø· Ø§Ù„Ø¥Ø¯Ù…Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¢Ù†.`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification('ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
          break;
          
        case 'unlock':
          // ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
          await set(chatSettingsRef, {
            isLocked: false,
            lockedBy: null,
            lockReason: null,
            lockedUntil: null,
            lockedAt: null
          });
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `ğŸ”“ Ù‚Ø§Ù… ${currentUser.name} (${currentUser.shortId}) Ø¨ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification('ØªÙ… ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
          break;
          
        case 'mute':
          if (!targetUserId) {
            showCommandModal('mute', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙƒØªÙ…');
            return;
          }
          
          // ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø©
          const muteUntil = new Date();
          muteUntil.setHours(muteUntil.getHours() + 1);
          
          await set(ref(db, `mutedUsers/${targetUserId}`), {
            mutedBy: currentUser.shortId,
            mutedUntil: muteUntil.toISOString(),
            mutedAt: serverTimestamp(),
            userName: targetUserName,
            shortId: targetShortId
          });
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `ğŸ¤« Ù‚Ø§Ù… ${currentUser.name} (${currentUser.shortId}) Ø¨ÙƒØªÙ… ${targetUserName} (${targetShortId}) Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø©.`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification(`ØªÙ… ÙƒØªÙ… ${targetUserName} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
          break;
          
        case 'unmute':
          if (!targetUserId) {
            showCommandModal('unmute', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ…');
            return;
          }
          
          // Ø¥Ø²Ø§Ù„Ø© ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          await remove(ref(db, `mutedUsers/${targetUserId}`));
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `ğŸ¤ Ù‚Ø§Ù… ${currentUser.name} (${currentUser.shortId}) Ø¨Ø¥Ø²Ø§Ù„Ø© ÙƒØªÙ… ${targetUserName} (${targetShortId}).`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification(`ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙƒØªÙ… ${targetUserName} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
          break;
          
        case 'role':
          if (!targetUserId) {
            showCommandModal('role', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ±Ù‚ÙŠØªÙ‡ Ø¥Ù„Ù‰ Ø¥Ø¯Ù…Ù†');
            return;
          }
          
          // ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø¥Ø¯Ù…Ù†
          await set(ref(db, `users/${targetUserId}/isAdmin`), true);
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `ğŸ‘‘ Ù‚Ø§Ù… ${currentUser.name} (${currentUser.shortId}) Ø¨ØªØ±Ù‚ÙŠØ© ${targetUserName} (${targetShortId}) Ø¥Ù„Ù‰ Ø¥Ø¯Ù…Ù†.`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification(`ØªÙ… ØªØ±Ù‚ÙŠØ© ${targetUserName} Ø¥Ù„Ù‰ Ø¥Ø¯Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­`, 'success');
          break;
          
        case 'unrole':
          if (!targetUserId) {
            showCommandModal('unrole', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù†');
            return;
          }
          
          // Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù†
          await set(ref(db, `users/${targetUserId}/isAdmin`), false);
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `ğŸ‘¤ Ù‚Ø§Ù… ${currentUser.name} (${currentUser.shortId}) Ø¨Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù† Ù…Ù† ${targetUserName} (${targetShortId}).`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification(`ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù† Ù…Ù† ${targetUserName} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
          break;
      }
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±', 'error');
    }
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
  function showCommandPalette() {
    commandList.innerHTML = '';
    
    const commands = [
      { icon: 'ğŸ”’', command: 'Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©', shortcut: '/lock', action: () => executeCommand('lock', null, null, null) },
      { icon: 'ğŸ”“', command: 'ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©', shortcut: '/unlock', action: () => executeCommand('unlock', null, null, null) },
      { icon: 'ğŸ—‘ï¸', command: 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', shortcut: '/clear', action: () => clearChatBtn.click() },
      { icon: 'ğŸ“Š', command: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', shortcut: '/stats', action: () => statsBtn.click() },
      { icon: 'ğŸ¤«', command: 'ÙƒØªÙ… Ù…Ø³ØªØ®Ø¯Ù…', shortcut: '/mute', action: () => muteBtn.click() },
      { icon: 'ğŸ¤', command: 'Ø¥Ø²Ø§Ù„Ø© ÙƒØªÙ…', shortcut: '/unmute', action: () => unmuteBtn.click() },
      { icon: 'ğŸ‘‘', command: 'ØªØ±Ù‚ÙŠØ© Ù„Ø¥Ø¯Ù…Ù†', shortcut: '/role', action: () => roleBtn.click() },
      { icon: 'ğŸ‘¤', command: 'Ø¥Ø²Ø§Ù„Ø© ØªØ±Ù‚ÙŠØ©', shortcut: '/unrole', action: () => unroleBtn.click() }
    ];
    
    commands.forEach(cmd => {
      if (!currentUser.isAdmin && ['lock', 'unlock', 'clear', 'stats', 'mute', 'unmute', 'role', 'unrole'].some(c => cmd.shortcut.includes(c))) {
        return;
      }
      
      const item = document.createElement('div');
      item.className = 'command-item';
      item.innerHTML = `
        <span style="font-size: 18px;">${cmd.icon}</span>
        <span>${cmd.command}</span>
        <span class="command-shortcut">${cmd.shortcut}</span>
      `;
      
      item.addEventListener('click', () => {
        cmd.action();
        hideCommandPalette();
      });
      
      commandList.appendChild(item);
    });
    
    commandPalette.style.display = 'block';
    setTimeout(() => commandPalette.style.opacity = '1', 10);
  }

  // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
  function hideCommandPalette() {
    commandPalette.style.opacity = '0';
    setTimeout(() => commandPalette.style.display = 'none', 300);
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  async function sendMessage() {
    const rawText = messageInput.value.trim();
    const text = sanitizeText(rawText);
    
    if (!text) {
      showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©', 'error');
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (mutedUsers[currentUser.uid]) {
      const muteUntil = new Date(mutedUsers[currentUser.uid].mutedUntil);
      const now = new Date();
      
      if (muteUntil > now) {
        const diff = Math.ceil((muteUntil - now) / (1000 * 60));
        showNotification(`Ø£Ù†Øª Ù…ÙƒØªÙˆÙ… Ù„Ù…Ø¯Ø© ${diff} Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰`, 'error');
        return;
      } else {
        await remove(ref(db, `mutedUsers/${currentUser.uid}`));
      }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    if (chatLockedUntil) {
      const lockUntil = new Date(chatLockedUntil);
      const now = new Date();
      
      if (lockUntil > now && !currentUser.isAdmin) {
        showNotification('Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹. ÙÙ‚Ø· Ø§Ù„Ø¥Ø¯Ù…Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©.', 'error');
        return;
      }
    }
    
    try {
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Firebase
      await push(messagesRef, {
        userId: currentUser.uid,
        shortId: currentUser.shortId,
        userName: currentUser.name,
        userAvatar: currentUser.avatar,
        text: text,
        timestamp: serverTimestamp(),
        isAdmin: currentUser.isAdmin
      });
      
      // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      messageInput.value = '';
      messageInput.focus();
      
      // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
      await remove(ref(db, `typing/${currentUser.uid}`));
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
    }
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø²Ø±
  sendBtn.addEventListener('click', sendMessage);

  // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
  messageInput.addEventListener('input', () => {
    // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ù„Ù‰ Firebase
    const typingRefUser = ref(db, `typing/${currentUser.uid}`);
    set(typingRefUser, true);
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      remove(typingRefUser);
    }, 2000);
  });

  // ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ /
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === '/' && messageInput.value === '/') {
      e.preventDefault();
      showCommandPalette();
    } else if (e.key === 'Escape') {
      hideCommandPalette();
    }
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener('click', (e) => {
    if (!commandPalette.contains(e.target) && e.target !== messageInput) {
      hideCommandPalette();
    }
  });

  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  const processedMessages = new Set();
  
  onChildAdded(messagesRef, async (snapshot) => {
    const message = snapshot.val();
    const messageId = snapshot.key;
    
    // Ù…Ù†Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ÙØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±ØªÙŠÙ†
    if (processedMessages.has(messageId)) return;
    processedMessages.add(messageId);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø³Ù„
    if (mutedUsers[message.userId] && !currentUser.isAdmin) {
      const muteUntil = new Date(mutedUsers[message.userId].mutedUntil);
      const now = new Date();
      
      if (muteUntil > now) {
        return;
      }
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    await displayMessage(message, messageId);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø¯Ø¯ 200
    const allMessages = messagesContainer.querySelectorAll('.message');
    if (allMessages.length > 200) {
      for (let i = 0; i < allMessages.length - 200; i++) {
        allMessages[i].remove();
      }
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });

  // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  async function displayMessage(message, messageId) {
    const messageDiv = document.createElement('div');
    
    // Ø¥Ø¶Ø§ÙØ© ID ÙØ±ÙŠØ¯ Ù„Ù„Ø±Ø³Ø§Ù„Ø©
    messageDiv.id = `msg-${messageId}`;
    
    if (message.userId === 'system') {
      messageDiv.className = 'message system';
    } else {
      messageDiv.className = `message ${message.userId === currentUser.uid ? 'self' : 'other'} ${message.isAdmin ? 'admin' : ''}`;
    }
    
    messageDiv.dataset.messageId = messageId;
    messageDiv.dataset.userId = message.userId;
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
    let timeString = 'Ø§Ù„Ø¢Ù†';
    if (message.timestamp) {
      const time = new Date(message.timestamp);
      if (!isNaN(time.getTime())) {
        timeString = time.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
      }
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    if (message.userId === 'system') {
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="message-text">${message.text}</div>
        </div>
      `;
    } else {
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ ID Ø§Ù„Ù‚ØµÙŠØ± ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶
      const displayName = `${message.userName} (${message.shortId || 'ID'})${message.isAdmin ? ' ğŸ‘‘' : ''}`;
      
      messageDiv.innerHTML = `
        <img src="${message.userAvatar}" class="message-avatar" alt="${message.userName}"
             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(message.userName)}&background=6d8ed1&color=fff'">
        <div class="message-content">
          <div class="message-header">
            <span class="message-name">${displayName}</span>
            <span class="message-time">${timeString}</span>
          </div>
          <div class="message-text">${message.text}</div>
        </div>
        ${currentUser.isAdmin && message.userId !== 'system' ? `<button class="delete-btn" onclick="deleteMessage('${messageId}')">Ã—</button>` : ''}
      `;
      
      // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…
      const reactionsDiv = document.createElement('div');
      reactionsDiv.className = 'message-reactions';
      
      // Ø¬Ù„Ø¨ Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      const reactionsSnapshot = await get(ref(db, `reactions/${messageId}`));
      if (reactionsSnapshot.exists()) {
        const reactions = reactionsSnapshot.val();
        const reactionCounts = {};
        
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ ÙƒÙ„ Ø±Ø¯ ÙØ¹Ù„
        Object.values(reactions).forEach(reaction => {
          reactionCounts[reaction.emoji] = (reactionCounts[reaction.emoji] || 0) + 1;
        });
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„
        availableReactions.forEach(emoji => {
          const count = reactionCounts[emoji] || 0;
          if (count > 0 || Math.random() > 0.5) { // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø¹Ø¶ Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§
            const reactionBtn = document.createElement('button');
            reactionBtn.className = 'reaction-btn';
            reactionBtn.innerHTML = `${emoji} <span class="reaction-count">${count}</span>`;
            
            reactionBtn.addEventListener('click', async () => {
              await addReaction(messageId, emoji);
            });
            
            reactionsDiv.appendChild(reactionBtn);
          }
        });
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
      if (reactionsDiv.children.length < 4) {
        availableReactions.slice(0, 4 - reactionsDiv.children.length).forEach(emoji => {
          const reactionBtn = document.createElement('button');
          reactionBtn.className = 'reaction-btn';
          reactionBtn.innerHTML = `${emoji} <span class="reaction-count">0</span>`;
          
          reactionBtn.addEventListener('click', async () => {
            await addReaction(messageId, emoji);
          });
          
          reactionsDiv.appendChild(reactionBtn);
        });
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      messageDiv.querySelector('.message-content').appendChild(reactionsDiv);
    }
    
    messagesContainer.appendChild(messageDiv);
  }

  // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ ÙØ¹Ù„
  async function addReaction(messageId, emoji) {
    try {
      const reactionId = `reaction_${Date.now()}`;
      await set(ref(db, `reactions/${messageId}/${reactionId}`), {
        userId: currentUser.uid,
        userName: currentUser.name,
        emoji: emoji,
        timestamp: serverTimestamp()
      });
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„ÙØ¹Ù„:', error);
    }
  }

  // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  window.deleteMessage = function(messageId) {
    if (!currentUser.isAdmin) return;
    
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
      remove(ref(db, `messages/${messageId}`));
      showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'success');
    }
  };

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  onValue(messagesRef, (snapshot) => {
    if (snapshot.exists()) {
      const messages = snapshot.val();
      messageCountValue = Object.keys(messages).length;
    } else {
      messageCountValue = 0;
    }
    messageCount.textContent = `${messageCountValue} Ø±Ø³Ø§Ù„Ø©`;
  });

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
  window.addEventListener('online', () => {
    onlineStatus.textContent = 'âœ“ Ù…ØªØµÙ„';
    onlineStatus.style.color = '';
    
    if (currentUser.uid) {
      set(ref(db, `users/${currentUser.uid}/lastSeen`), serverTimestamp());
    }
  });
  
  window.addEventListener('offline', () => {
    onlineStatus.textContent = 'âœ— ØºÙŠØ± Ù…ØªØµÙ„';
    onlineStatus.style.color = '#ff4757';
  });

  // Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù‡ÙˆØ§ØªÙ
  function vibrateIfSupported() {
    if ('vibrate' in navigator) {
      navigator.vibrate(50);
    }
  }

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±
  window.showNotification = showNotification;
  window.showNotification = function(message, type = 'info') {
    vibrateIfSupported();
    showNotification(message, type);
  };

</script>

</body>
</html>
