<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التسوق الإلكتروني</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2E86C1;
            --secondary: #17A2B8;
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --dark: #343A40;
            --light: #F8F9FA;
            --gray: #6C757D;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* الهيدر */
        header {
            background: linear-gradient(135deg, var(--primary), #1B4F72);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-left: 10px;
            font-size: 28px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .balance {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .balance:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            position: relative;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .user-menu {
            display: none;
            position: absolute;
            top: 50px;
            left: 0;
            background: white;
            color: #333;
            width: 200px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .user-menu.active {
            display: block;
        }
        
        .user-menu a {
            display: block;
            padding: 12px 15px;
            text-decoration: none;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        
        .user-menu a:hover {
            background: #f5f5f5;
        }
        
        .user-menu a:last-child {
            border-bottom: none;
        }
        
        .login-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: #218838;
        }
        
        /* المحتوى الرئيسي */
        .main-content {
            padding: 30px 0;
            min-height: calc(100vh - 160px);
        }
        
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            color: var(--dark);
        }
        
        /* قسم العروض */
        .offers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .offer-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .offer-card:hover {
            transform: translateY(-5px);
        }
        
        .offer-image {
            height: 160px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
        }
        
        .offer-content {
            padding: 15px;
        }
        
        .offer-title {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .offer-price {
            font-weight: bold;
            color: var(--primary);
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .buy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .buy-btn:hover {
            background: #1B4F72;
        }
        
        /* قسم الممتلكات */
        .possessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .possession-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .possession-image {
            height: 140px;
            background: linear-gradient(45deg, var(--warning), var(--danger));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
        }
        
        .possession-content {
            padding: 15px;
        }
        
        .possession-title {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        /* لوحة الإدارة */
        .admin-panel {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .admin-tab.active {
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .admin-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .admin-btn:hover {
            background: #1B4F72;
        }
        
        .admin-btn.danger {
            background: var(--danger);
        }
        
        .admin-btn.danger:hover {
            background: #BD2130;
        }
        
        .users-list, .codes-list, .products-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .user-item, .code-item, .product-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .user-item:last-child, .code-item:last-child, .product-item:last-child {
            border-bottom: none;
        }
        
        /* نافذة إدخال كود الشحن */
        .charge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .charge-modal.active {
            display: flex;
        }
        
        .charge-form {
            background: white;
            width: 400px;
            max-width: 90%;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .charge-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* نافذة إدخال كود الأدمن */
        .admin-code-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .admin-code-modal.active {
            display: flex;
        }
        
        .admin-code-form {
            background: white;
            width: 400px;
            max-width: 90%;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .admin-code-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        /* الفوتر */
        footer {
            background: var(--dark);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-top: 40px;
        }
        
        /* رسائل التنبيه */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* التجاوب مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                order: 3;
                width: 100%;
                justify-content: center;
            }
            
            .user-section {
                order: 2;
            }
            
            .logo {
                order: 1;
            }
            
            .offers-grid, .possessions-grid {
                grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- الهيدر -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-store"></i>
                    متجرنا الإلكتروني
                </div>
                
                <div class="nav-links">
                    <a href="#offers">العروض</a>
                    <a href="#possessions">ممتلكاتي</a>
                </div>
                
                <div class="user-section">
                    <div class="balance" id="user-balance" onclick="openChargeModal()">0 <i class="fas fa-coins"></i></div>
                    
                    <div class="user-profile" id="user-profile" style="display: none;">
                        <img id="user-avatar" class="user-avatar" alt="صورة المستخدم">
                        <span id="user-name"></span>
                        <div class="user-menu" id="user-menu">
                            <a href="#" id="admin-login-btn">تسجيل كأدمن</a>
                            <a href="#" onclick="signOut()">تسجيل الخروج</a>
                        </div>
                    </div>
                    
                    <div id="g_id_onload"
                         data-client_id="487544903475-l4hjabntdpa92jbqdp69omrc39hu23f9.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleCredentialResponse"
                         data-auto_prompt="false">
                    </div>
                    
                    <div id="g_id_signin" class="login-btn" style="display: none;">
                        تسجيل الدخول
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <div class="container">
        <div class="main-content">
            <!-- قسم العروض -->
            <section id="offers">
                <h2 class="section-title">العروض</h2>
                <div class="offers-grid" id="offers-grid">
                    <!-- سيتم ملؤها بالعروض -->
                </div>
            </section>
            
            <!-- قسم الممتلكات -->
            <section id="possessions">
                <h2 class="section-title">ممتلكاتي</h2>
                <div class="possessions-grid" id="possessions-grid">
                    <!-- سيتم ملؤها بالممتلكات -->
                </div>
            </section>
            
            <!-- لوحة الإدارة -->
            <div class="admin-panel" id="admin-panel">
                <h2 class="section-title">لوحة الإدارة</h2>
                
                <div class="admin-tabs">
                    <div class="admin-tab active" onclick="switchAdminTab('codes-tab')">أكواد الشحن</div>
                    <div class="admin-tab" onclick="switchAdminTab('products-tab')">إدارة العروض</div>
                    <div class="admin-tab" onclick="switchAdminTab('users-tab')">إدارة المستخدمين</div>
                </div>
                
                <!-- تبويب أكواد الشحن -->
                <div id="codes-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="charge-code">كود الشحن:</label>
                        <input type="text" id="charge-code" class="form-control" placeholder="أدخل الكود">
                    </div>
                    
                    <div class="form-group">
                        <label for="charge-value">قيمة الشحن:</label>
                        <input type="number" id="charge-value" class="form-control" placeholder="أدخل القيمة">
                    </div>
                    
                    <button class="admin-btn" onclick="generateChargeCode()">إنشاء كود شحن</button>
                    
                    <h3 style="margin: 20px 0 10px;">الأكواد المنشأة</h3>
                    <div class="codes-list" id="codes-list">
                        <!-- سيتم ملؤها بالأكواد -->
                    </div>
                </div>
                
                <!-- تبويب إدارة العروض -->
                <div id="products-tab" class="tab-content">
                    <div class="form-group">
                        <label for="product-name">اسم العرض:</label>
                        <input type="text" id="product-name" class="form-control" placeholder="أدخل اسم العرض">
                    </div>
                    
                    <div class="form-group">
                        <label for="product-price">سعر العرض:</label>
                        <input type="number" id="product-price" class="form-control" placeholder="أدخل السعر">
                    </div>
                    
                    <button class="admin-btn" onclick="addProduct()">إضافة عرض</button>
                    
                    <h3 style="margin: 20px 0 10px;">العروض المضافة</h3>
                    <div class="products-list" id="admin-products-list">
                        <!-- سيتم ملؤها بالعروض -->
                    </div>
                </div>
                
                <!-- تبويب إدارة المستخدمين -->
                <div id="users-tab" class="tab-content">
                    <div class="form-group">
                        <label for="user-id">ايدي المستخدم:</label>
                        <input type="text" id="user-id" class="form-control" placeholder="أدخل ايدي المستخدم">
                    </div>
                    
                    <button class="admin-btn" onclick="resetUserMoney()">تصفير أموال المستخدم</button>
                    <button class="admin-btn" onclick="resetUserProducts()">تصفير عروض المستخدم</button>
                    
                    <h3 style="margin: 20px 0 10px;">إجراءات عامة</h3>
                    <button class="admin-btn danger" onclick="resetAllMoney()">تصفير أموال الجميع</button>
                    <button class="admin-btn danger" onclick="resetAllProducts()">تصفير عروض الجميع</button>
                    
                    <h3 style="margin: 20px 0 10px;">قائمة المستخدمين</h3>
                    <div class="users-list" id="users-list">
                        <!-- سيتم ملؤها بالمستخدمين -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعبئة المحفظة -->
    <div class="charge-modal" id="charge-modal">
        <div class="charge-form">
            <h2>تعبئة المحفظة</h2>
            
            <div class="form-group">
                <label for="charge-code-input">كود الشحن:</label>
                <input type="text" id="charge-code-input" class="form-control" placeholder="أدخل كود الشحن">
            </div>
            
            <div class="modal-buttons">
                <button class="admin-btn" onclick="useChargeCode()">تأكيد</button>
                <button class="admin-btn danger" onclick="closeChargeModal()">إغلاق</button>
            </div>
            
            <div id="charge-message" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- نافذة إدخال كود الأدمن -->
    <div class="admin-code-modal" id="admin-code-modal">
        <div class="admin-code-form">
            <h2>إدخال كود الأدمن</h2>
            
            <div class="form-group">
                <label for="admin-code-input">كود الأدمن:</label>
                <input type="text" id="admin-code-input" class="form-control" placeholder="أدخل كود الأدمن">
            </div>
            
            <div class="modal-buttons">
                <button class="admin-btn" onclick="verifyAdminCode()">تأكيد</button>
                <button class="admin-btn danger" onclick="closeAdminCodeModal()">إغلاق</button>
            </div>
            
            <div id="admin-code-message" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- الفوتر -->
    <footer>
        <div class="container">
            <p>جميع الحقوق محفوظة &copy; 2023 متجرنا الإلكتروني</p>
        </div>
    </footer>

    <script>
        // بيانات التطبيق
        let currentUser = null;
        let isAdmin = false;
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let chargeCodes = JSON.parse(localStorage.getItem('chargeCodes')) || [];
        
        // تهيئة التطبيق
        window.onload = function() {
            initializeGoogleSignIn();
            checkLoginStatus();
            loadOffers();
            loadPossessions();
            loadAdminData();
        };
        
        // تهيئة تسجيل الدخول بـ Google
        function initializeGoogleSignIn() {
            // إضافة زر تسجيل الدخول يدويًا
            const g_id_signin = document.getElementById('g_id_signin');
            g_id_signin.addEventListener('click', function() {
                google.accounts.id.prompt();
            });
            
            // تهيئة Google Sign-In
            google.accounts.id.initialize({
                client_id: "487544903475-l4hjabntdpa92jbqdp69omrc39hu23f9.apps.googleusercontent.com",
                callback: handleCredentialResponse,
                auto_select: false
            });
            
            // عرض زر تسجيل الدخول
            document.getElementById('g_id_signin').style.display = 'block';
        }
        
        // معالجة استجابة تسجيل الدخول
        function handleCredentialResponse(response) {
            console.log("تم استقبال بيانات تسجيل الدخول");
            
            const jwt = response.credential;
            
            // فك تشفير JWT للحصول على بيانات المستخدم
            const base64Url = jwt.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            const userData = JSON.parse(jsonPayload);
            console.log("بيانات المستخدم:", userData);
            
            // البحث عن المستخدم أو إنشاء حساب جديد
            let user = users.find(u => u.email === userData.email);
            
            if (!user) {
                // إنشاء مستخدم جديد
                user = {
                    id: generateId(),
                    name: userData.name,
                    email: userData.email,
                    picture: userData.picture,
                    balance: 0,
                    possessions: [],
                    isAdmin: false
                };
                
                users.push(user);
                localStorage.setItem('users', JSON.stringify(users));
                console.log("تم إنشاء مستخدم جديد:", user);
            } else {
                console.log("تم العثور على مستخدم موجود:", user);
            }
            
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            updateUI();
            showMessage('تم تسجيل الدخول بنجاح', 'success');
        }
        
        // تسجيل الخروج
        function signOut() {
            currentUser = null;
            isAdmin = false;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isAdmin');
            
            // تسجيل الخروج من Google
            google.accounts.id.disableAutoSelect();
            google.accounts.id.cancel();
            
            updateUI();
            showMessage('تم تسجيل الخروج بنجاح', 'success');
        }
        
        // التحقق من حالة تسجيل الدخول
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isAdmin = localStorage.getItem('isAdmin') === 'true';
                updateUI();
                console.log("تم استعادة حالة تسجيل الدخول:", currentUser);
            }
        }
        
        // تحديث واجهة المستخدم
        function updateUI() {
            const g_id_signin = document.getElementById('g_id_signin');
            const userProfile = document.getElementById('user-profile');
            const userName = document.getElementById('user-name');
            const userAvatar = document.getElementById('user-avatar');
            const userBalance = document.getElementById('user-balance');
            const adminPanel = document.getElementById('admin-panel');
            
            if (currentUser) {
                g_id_signin.style.display = 'none';
                userProfile.style.display = 'flex';
                userName.textContent = currentUser.name;
                userAvatar.src = currentUser.picture;
                userBalance.textContent = currentUser.balance + ' ⬤';
                
                if (isAdmin) {
                    adminPanel.style.display = 'block';
                    console.log("تم تفعيل لوحة الإدارة");
                } else {
                    adminPanel.style.display = 'none';
                }
            } else {
                g_id_signin.style.display = 'block';
                userProfile.style.display = 'none';
                adminPanel.style.display = 'none';
            }
            
            loadPossessions();
        }
        
        // عرض رسالة
        function showMessage(message, type) {
            // إنشاء عنصر رسالة مؤقت
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
            messageDiv.textContent = message;
            
            // إضافة الرسالة إلى بداية body
            document.body.prepend(messageDiv);
            
            // إزالة الرسالة بعد 3 ثواني
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // توليد معرف فريد
        function generateId() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }
        
        // تحميل العروض
        function loadOffers() {
            const offersGrid = document.getElementById('offers-grid');
            offersGrid.innerHTML = '';
            
            if (products.length === 0) {
                // إضافة عروض افتراضية إذا لم توجد
                products = [
                    { id: 1, name: 'عرض خاص', price: 100, icon: 'fas fa-gift' },
                    { id: 2, name: 'خصم 20%', price: 150, icon: 'fas fa-percentage' },
                    { id: 3, name: 'عرض موسمي', price: 200, icon: 'fas fa-sun' },
                    { id: 4, name: 'عرض نهاية الأسبوع', price: 80, icon: 'fas fa-calendar-week' }
                ];
                localStorage.setItem('products', JSON.stringify(products));
            }
            
            products.forEach(product => {
                const offerCard = document.createElement('div');
                offerCard.className = 'offer-card';
                offerCard.innerHTML = `
                    <div class="offer-image">
                        <i class="${product.icon}"></i>
                    </div>
                    <div class="offer-content">
                        <h3 class="offer-title">${product.name}</h3>
                        <div class="offer-price">${product.price} ⬤</div>
                        <button class="buy-btn" onclick="buyProduct(${product.id})">شراء الآن</button>
                    </div>
                `;
                offersGrid.appendChild(offerCard);
            });
        }
        
        // تحميل الممتلكات
        function loadPossessions() {
            const possessionsGrid = document.getElementById('possessions-grid');
            possessionsGrid.innerHTML = '';
            
            if (!currentUser || currentUser.possessions.length === 0) {
                possessionsGrid.innerHTML = '<p>لا تمتلك أي عروض حالياً</p>';
                return;
            }
            
            currentUser.possessions.forEach(possessionId => {
                const product = products.find(p => p.id === possessionId);
                if (product) {
                    const possessionCard = document.createElement('div');
                    possessionCard.className = 'possession-card';
                    possessionCard.innerHTML = `
                        <div class="possession-image">
                            <i class="${product.icon}"></i>
                        </div>
                        <div class="possession-content">
                            <h3 class="possession-title">${product.name}</h3>
                            <p>تم الشراء بتاريخ: ${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>
                    `;
                    possessionsGrid.appendChild(possessionCard);
                }
            });
        }
        
        // شراء عرض
        function buyProduct(productId) {
            if (!currentUser) {
                showMessage('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                showMessage('العرض غير موجود', 'error');
                return;
            }
            
            if (currentUser.balance < product.price) {
                showMessage('رصيدك غير كافي لشراء هذا العرض', 'error');
                return;
            }
            
            // التحقق إذا كان المستخدم يمتلك العرض بالفعل
            if (currentUser.possessions.includes(productId)) {
                showMessage('أنت تمتلك هذا العرض بالفعل', 'error');
                return;
            }
            
            // خصم السعر من الرصيد
            currentUser.balance -= product.price;
            
            // إضافة العرض إلى الممتلكات
            currentUser.possessions.push(productId);
            
            // تحديث بيانات المستخدم في القائمة
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            updateUI();
            showMessage('تم شراء العرض بنجاح', 'success');
        }
        
        // فتح نافذة تعبئة المحفظة
        function openChargeModal() {
            if (!currentUser) {
                showMessage('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            document.getElementById('charge-modal').classList.add('active');
        }
        
        // إغلاق نافذة تعبئة المحفظة
        function closeChargeModal() {
            document.getElementById('charge-modal').classList.remove('active');
            document.getElementById('charge-message').innerHTML = '';
            document.getElementById('charge-code-input').value = '';
        }
        
        // استخدام كود الشحن
        function useChargeCode() {
            const code = document.getElementById('charge-code-input').value;
            
            if (!code) {
                document.getElementById('charge-message').innerHTML = 
                    '<div class="alert alert-danger">يرجى إدخال كود الشحن</div>';
                return;
            }
            
            const chargeCode = chargeCodes.find(c => c.code === code);
            
            if (!chargeCode) {
                document.getElementById('charge-message').innerHTML = 
                    '<div class="alert alert-danger">كود الشحن غير صحيح</div>';
                return;
            }
            
            if (chargeCode.used) {
                document.getElementById('charge-message').innerHTML = 
                    '<div class="alert alert-danger">هذا الكود مستخدم مسبقاً</div>';
                return;
            }
            
            // إضافة القيمة إلى رصيد المستخدم
            currentUser.balance += chargeCode.value;
            
            // تعليم الكود كمستخدم وحذفه من القائمة
            chargeCode.used = true;
            chargeCodes = chargeCodes.filter(c => c.code !== code);
            
            localStorage.setItem('chargeCodes', JSON.stringify(chargeCodes));
            
            // تحديث بيانات المستخدم
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            closeChargeModal();
            updateUI();
            showMessage(`تم تعبئة محفظتك بمبلغ ${chargeCode.value} ⬤ بنجاح`, 'success');
        }
        
        // فتح نافذة إدخال كود الأدمن
        document.getElementById('admin-login-btn').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('admin-code-modal').classList.add('active');
            document.getElementById('user-menu').classList.remove('active');
        });
        
        // إغلاق نافذة إدخال كود الأدمن
        function closeAdminCodeModal() {
            document.getElementById('admin-code-modal').classList.remove('active');
            document.getElementById('admin-code-message').innerHTML = '';
            document.getElementById('admin-code-input').value = '';
        }
        
        // التحقق من كود الأدمن
        function verifyAdminCode() {
            const adminCode = document.getElementById('admin-code-input').value;
            
            if (adminCode === '5GHJKO3') {
                isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                currentUser.isAdmin = true;
                
                // تحديث بيانات المستخدم
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                closeAdminCodeModal();
                updateUI();
                showMessage('تم التحقق من هوية الأدمن بنجاح', 'success');
            } else {
                document.getElementById('admin-code-message').innerHTML = 
                    '<div class="alert alert-danger">كود الأدمن غير صحيح</div>';
            }
        }
        
        // تبديل تبويبات الإدارة
        function switchAdminTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            if (tabId === 'codes-tab') {
                loadChargeCodes();
            } else if (tabId === 'products-tab') {
                loadAdminProducts();
            } else if (tabId === 'users-tab') {
                loadUsersList();
            }
        }
        
        // تحميل بيانات الإدارة
        function loadAdminData() {
            loadChargeCodes();
            loadAdminProducts();
            loadUsersList();
        }
        
        // تحميل أكواد الشحن
        function loadChargeCodes() {
            const codesList = document.getElementById('codes-list');
            codesList.innerHTML = '';
            
            chargeCodes.forEach(code => {
                const codeItem = document.createElement('div');
                codeItem.className = 'code-item';
                codeItem.innerHTML = `
                    <div>${code.code} - ${code.value} ⬤</div>
                    <div>${code.used ? 'مستخدم' : 'غير مستخدم'}</div>
                `;
                codesList.appendChild(codeItem);
            });
        }
        
        // تحميل العروض في لوحة الإدارة
        function loadAdminProducts() {
            const adminProductsList = document.getElementById('admin-products-list');
            adminProductsList.innerHTML = '';
            
            products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div>${product.name} - ${product.price} ⬤</div>
                    <button class="admin-btn danger" onclick="deleteProduct(${product.id})">حذف</button>
                `;
                adminProductsList.appendChild(productItem);
            });
        }
        
        // تحميل قائمة المستخدمين
        function loadUsersList() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div>${user.name} (${user.email}) - ID: ${user.id}</div>
                    <div>${user.balance} ⬤</div>
                `;
                usersList.appendChild(userItem);
            });
        }
        
        // إنشاء كود شحن
        function generateChargeCode() {
            const code = document.getElementById('charge-code').value;
            const value = parseInt(document.getElementById('charge-value').value);
            
            if (!code || !value) {
                showMessage('يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            if (chargeCodes.find(c => c.code === code)) {
                showMessage('هذا الكود موجود بالفعل', 'error');
                return;
            }
            
            const chargeCode = {
                code: code,
                value: value,
                used: false
            };
            
            chargeCodes.push(chargeCode);
            localStorage.setItem('chargeCodes', JSON.stringify(chargeCodes));
            
            document.getElementById('charge-code').value = '';
            document.getElementById('charge-value').value = '';
            
            loadChargeCodes();
            showMessage('تم إنشاء كود الشحن بنجاح', 'success');
        }
        
        // إضافة عرض
        function addProduct() {
            const name = document.getElementById('product-name').value;
            const price = parseInt(document.getElementById('product-price').value);
            
            if (!name || !price) {
                showMessage('يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            const product = {
                id: generateId(),
                name: name,
                price: price,
                icon: 'fas fa-gift'
            };
            
            products.push(product);
            localStorage.setItem('products', JSON.stringify(products));
            
            document.getElementById('product-name').value = '';
            document.getElementById('product-price').value = '';
            
            loadOffers();
            loadAdminProducts();
            showMessage('تم إضافة العرض بنجاح', 'success');
        }
        
        // حذف عرض
        function deleteProduct(productId) {
            if (confirm('هل أنت متأكد من حذف هذا العرض؟')) {
                products = products.filter(p => p.id !== productId);
                localStorage.setItem('products', JSON.stringify(products));
                
                // إزالة العرض من ممتلكات جميع المستخدمين
                users.forEach(user => {
                    user.possessions = user.possessions.filter(p => p !== productId);
                });
                localStorage.setItem('users', JSON.stringify(users));
                
                // تحديث بيانات المستخدم الحالي إذا كان يمتلك العرض
                if (currentUser && currentUser.possessions.includes(productId)) {
                    currentUser.possessions = currentUser.possessions.filter(p => p !== productId);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                loadOffers();
                loadAdminProducts();
                loadPossessions();
                showMessage('تم حذف العرض بنجاح', 'success');
            }
        }
        
        // تصفير أموال مستخدم
        function resetUserMoney() {
            const userId = document.getElementById('user-id').value;
            
            if (!userId) {
                showMessage('يرجى إدخال ايدي المستخدم', 'error');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            
            if (!user) {
                showMessage('المستخدم غير موجود', 'error');
                return;
            }
            
            user.balance = 0;
            localStorage.setItem('users', JSON.stringify(users));
            
            if (currentUser && currentUser.id === userId) {
                currentUser.balance = 0;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUI();
            }
            
            document.getElementById('user-id').value = '';
            showMessage('تم تصفير أموال المستخدم بنجاح', 'success');
        }
        
        // تصفير عروض مستخدم
        function resetUserProducts() {
            const userId = document.getElementById('user-id').value;
            
            if (!userId) {
                showMessage('يرجى إدخال ايدي المستخدم', 'error');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            
            if (!user) {
                showMessage('المستخدم غير موجود', 'error');
                return;
            }
            
            user.possessions = [];
            localStorage.setItem('users', JSON.stringify(users));
            
            if (currentUser && currentUser.id === userId) {
                currentUser.possessions = [];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loadPossessions();
            }
            
            document.getElementById('user-id').value = '';
            showMessage('تم تصفير عروض المستخدم بنجاح', 'success');
        }
        
        // تصفير أموال الجميع
        function resetAllMoney() {
            if (confirm('هل أنت متأكد من تصفير أموال جميع المستخدمين؟')) {
                users.forEach(user => {
                    user.balance = 0;
                });
                
                localStorage.setItem('users', JSON.stringify(users));
                
                if (currentUser) {
                    currentUser.balance = 0;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateUI();
                }
                
                showMessage('تم تصفير أموال جميع المستخدمين بنجاح', 'success');
            }
        }
        
        // تصفير عروض الجميع
        function resetAllProducts() {
            if (confirm('هل أنت متأكد من تصفير عروض جميع المستخدمين؟')) {
                users.forEach(user => {
                    user.possessions = [];
                });
                
                localStorage.setItem('users', JSON.stringify(users));
                
                if (currentUser) {
                    currentUser.possessions = [];
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    loadPossessions();
                }
                
                showMessage('تم تصفير عروض جميع المستخدمين بنجاح', 'success');
            }
        }
        
        // إظهار/إخفاء قائمة المستخدم
        document.getElementById('user-profile').addEventListener('click', function() {
            document.getElementById('user-menu').classList.toggle('active');
        });
        
        // إغلاق قائمة المستخدم عند النقر خارجها
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-profile')) {
                document.getElementById('user-menu').classList.remove('active');
            }
        });
    </script>
</body>
    </html>
